{"version":3,"file":"QueryInfo.js","sources":["QueryInfo.js"],"sourcesContent":["import { equal } from \"@wry/equality\";\nimport { isNonEmptyArray } from '../utilities/common/arrays';\nimport { graphQLResultHasError } from '../utilities/common/errorHandling';\nimport { NetworkStatus, isNetworkRequestInFlight, } from './networkStatus';\nvar QueryInfo = (function () {\n    function QueryInfo(cache) {\n        this.cache = cache;\n        this.listeners = new Set();\n        this.document = null;\n        this.lastRequestId = 1;\n        this.observableQuery = null;\n        this.subscriptions = new Set();\n        this.dirty = false;\n        this.diff = null;\n    }\n    QueryInfo.prototype.init = function (query) {\n        var networkStatus;\n        if (this.variables &&\n            this.networkStatus !== NetworkStatus.loading &&\n            !equal(this.variables, query.variables)) {\n            networkStatus = NetworkStatus.setVariables;\n        }\n        else if (query.isPoll) {\n            networkStatus = NetworkStatus.poll;\n        }\n        else if (query.isRefetch) {\n            networkStatus = NetworkStatus.refetch;\n        }\n        else {\n            networkStatus = NetworkStatus.loading;\n        }\n        Object.assign(this, {\n            document: query.document,\n            variables: query.variables,\n            networkError: null,\n            graphQLErrors: this && this.graphQLErrors || [],\n            networkStatus: networkStatus,\n        });\n        if (query.observableQuery) {\n            this.observableQuery = query.observableQuery;\n        }\n        if (query.lastRequestId) {\n            this.lastRequestId = query.lastRequestId;\n        }\n        return this;\n    };\n    QueryInfo.prototype.setDirty = function () {\n        var _this = this;\n        if (!this.dirty) {\n            this.dirty = true;\n            if (!this.notifyTimeout) {\n                this.notifyTimeout = setTimeout(function () { return _this.notify(); }, 0);\n            }\n        }\n        return this;\n    };\n    QueryInfo.prototype.setDiff = function (diff) {\n        var _a, _b;\n        var oldDiff = this.diff;\n        this.diff = diff;\n        if (!this.dirty && ((_a = diff) === null || _a === void 0 ? void 0 : _a.result) !== ((_b = oldDiff) === null || _b === void 0 ? void 0 : _b.result)) {\n            this.setDirty();\n        }\n    };\n    QueryInfo.prototype.getDiff = function () {\n        if (!this.diff) {\n            var oq = this.observableQuery;\n            var lastResult = oq && oq.getLastResult();\n            var lastError = oq && oq.getLastError();\n            var fetchPolicy = oq && oq.options.fetchPolicy || \"cache-first\";\n            var errorPolicy = this.getErrorPolicy();\n            var errorStatusChanged = errorPolicy !== 'none' &&\n                (lastError && lastError.graphQLErrors) !== this.graphQLErrors;\n            if (lastResult && lastResult.data && !errorStatusChanged) {\n                this.diff = {\n                    result: lastResult.data,\n                    complete: true,\n                };\n            }\n            else if (fetchPolicy !== \"no-cache\" &&\n                fetchPolicy !== \"network-only\") {\n                this.diff = this.cache.diff({\n                    query: this.document,\n                    variables: this.variables,\n                    returnPartialData: true,\n                    optimistic: true,\n                });\n            }\n        }\n        return this.diff;\n    };\n    QueryInfo.prototype.getErrorPolicy = function () {\n        var oq = this.observableQuery;\n        return oq && oq.options.errorPolicy || \"none\";\n    };\n    QueryInfo.prototype.notify = function () {\n        var _this = this;\n        if (this.notifyTimeout) {\n            clearTimeout(this.notifyTimeout);\n            this.notifyTimeout = void 0;\n        }\n        if (this.shouldNotify() && this.getDiff()) {\n            this.listeners.forEach(function (listener) { return listener(_this); });\n        }\n        this.dirty = false;\n    };\n    QueryInfo.prototype.shouldNotify = function () {\n        if (!this.dirty || !this.listeners.size) {\n            return false;\n        }\n        if (!this.observableQuery) {\n            return true;\n        }\n        var _a = this.observableQuery.options, fetchPolicy = _a.fetchPolicy, returnPartialData = _a.returnPartialData, notifyOnNetworkStatusChange = _a.notifyOnNetworkStatusChange;\n        if (fetchPolicy === \"standby\") {\n            return false;\n        }\n        if (isNetworkRequestInFlight(this.networkStatus)) {\n            var lastResult = this.observableQuery.getLastResult();\n            var networkStatusChanged = !!(lastResult &&\n                lastResult.networkStatus !== this.networkStatus);\n            var shouldNotifyIfLoading = returnPartialData ||\n                this.networkStatus === NetworkStatus.setVariables ||\n                (networkStatusChanged && notifyOnNetworkStatusChange) ||\n                fetchPolicy === 'cache-only' ||\n                fetchPolicy === 'cache-and-network';\n            if (!shouldNotifyIfLoading) {\n                return false;\n            }\n        }\n        return true;\n    };\n    QueryInfo.prototype.stop = function () {\n        this.cancel();\n        delete this.cancel;\n        this.variables =\n            this.networkStatus =\n                this.networkError =\n                    this.graphQLErrors = void 0;\n    };\n    QueryInfo.prototype.cancel = function () { };\n    QueryInfo.prototype.updateWatch = function (options) {\n        var _this = this;\n        this.cancel();\n        var previousResult = function () {\n            var previousResult = null;\n            var observableQuery = _this.observableQuery;\n            if (observableQuery) {\n                var lastResult = observableQuery.getLastResult();\n                if (lastResult) {\n                    previousResult = lastResult.data;\n                }\n            }\n            return previousResult;\n        };\n        this.cancel = this.cache.watch({\n            query: this.document,\n            variables: options.variables,\n            optimistic: true,\n            previousResult: previousResult,\n            callback: function (diff) {\n                _this.setDiff(diff);\n            },\n        });\n        return this;\n    };\n    QueryInfo.prototype.markResult = function (result, _a, allowCacheWrite, makeReady) {\n        var fetchPolicy = _a.fetchPolicy, variables = _a.variables, errorPolicy = _a.errorPolicy;\n        if (fetchPolicy === 'no-cache') {\n            this.setDiff({ result: result.data, complete: true });\n        }\n        else if (allowCacheWrite) {\n            var ignoreErrors = errorPolicy === 'ignore' || errorPolicy === 'all';\n            var writeWithErrors = !graphQLResultHasError(result);\n            if (!writeWithErrors && ignoreErrors && result.data) {\n                writeWithErrors = true;\n            }\n            if (writeWithErrors) {\n                this.cache.write({\n                    result: result.data,\n                    dataId: 'ROOT_QUERY',\n                    query: this.document,\n                    variables: variables,\n                });\n            }\n        }\n        if (makeReady) {\n            this.networkError = null;\n            this.graphQLErrors = isNonEmptyArray(result.errors) ? result.errors : [];\n            this.networkStatus = NetworkStatus.ready;\n        }\n    };\n    QueryInfo.prototype.markError = function (error) {\n        this.networkError = error;\n        this.networkStatus = NetworkStatus.error;\n    };\n    return QueryInfo;\n}());\nexport { QueryInfo };\n//# sourceMappingURL=QueryInfo.js.map"],"names":[],"mappings":"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"}